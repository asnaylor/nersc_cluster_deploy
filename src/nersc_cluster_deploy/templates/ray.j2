#!/bin/bash
# Generated by nersc_cluster_deploy
#
{% if job.sbatch_options %}
{{ job.getSbatch() }}
{% endif %}

echo "[slurm] starting script..."

{% if job.job_setup %}
{{ job.getJob_setup() }}
{% endif %}

#Remove Rayhead from list of ray_workers
nodes=$(scontrol show hostnames $SLURM_JOB_NODELIST | grep -v {{ job.ray_headnode }} )
nodes_array=( $nodes )

{% raw %}
worker_num=${#nodes_array[@]}
{% endraw %}
echo "[slurm] - Starting $worker_num Ray worker nodes"

for ((  i=0; i<$worker_num; i++ ))
do
    node_i=${nodes_array[$i]}
    echo "    - $i at $node_i"
    srun --nodes=1 --ntasks-per-node=1 -w $node_i --cpus-per-task=128 --gpus-per-task=4 {{ job.srun_flags }} ray start --address {{ job.ray_head_address }} --num-cpus=128 --num-gpus=4 --block &
done

sleep infinity

echo "[slurm] Exiting script..."
exit
